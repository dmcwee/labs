{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "2987643258465669272"
    }
  },
  "parameters": {
    "password": {
      "type": "securestring"
    },
    "username": {
      "type": "string"
    },
    "gatewayCertData": {
      "type": "string"
    },
    "gatewayCertName": {
      "type": "string"
    },
    "size": {
      "type": "string",
      "defaultValue": "Standard_B1ms"
    }
  },
  "variables": {
    "labServers": [
      {
        "name": "vhagar",
        "ip": "10.90.30.20",
        "sku": "2019-DataCenter",
        "offer": "WindowsServer",
        "publisher": "MicrosoftWindowsServer",
        "osType": "Windows",
        "requirePlan": false,
        "tags": {
          "ExcludeMdeAutoProvisioning": "True"
        }
      },
      {
        "name": "drogon",
        "ip": "10.90.30.7",
        "publisher": "canonical",
        "offer": "0001-com-ubuntu-server-jammy",
        "sku": "22_04-lts-gen2",
        "osType": "Linux",
        "requirePlan": false,
        "tags": {
          "ExcludeMdeAutoProvisioning": "True"
        }
      },
      {
        "name": "kali",
        "ip": "10.90.30.26",
        "publisher": "kali-linux",
        "offer": "kali",
        "sku": "kali-2024-4",
        "osType": "Linux",
        "requirePlan": true,
        "plan": {
          "name": "kali-2024-4",
          "publisher": "kali-linux",
          "product": "kali"
        },
        "tags": {
          "ExcludeMdeAutoProvisioning": "True"
        }
      }
    ]
  },
  "resources": {
    "network": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('network-{0}', uniqueString('network', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "gatewayCertData": {
            "value": "[parameters('gatewayCertData')]"
          },
          "gatewayCertName": {
            "value": "[parameters('gatewayCertName')]"
          },
          "range": {
            "value": "10.90.0.0/16"
          },
          "clientRange": {
            "value": "10.90.30.0/24"
          },
          "gatewayRange": {
            "value": "10.90.100.0/24"
          },
          "gatewayClientRange": {
            "value": "10.10.10.0/24"
          },
          "vpnClientProtocol": {
            "value": [
              "IkeV2"
            ]
          },
          "gatewaySku": {
            "value": "VpnGw1"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "4384183637731990924"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "defaultValue": "[format('{0}-network', toLower(resourceGroup().name))]"
            },
            "gatewayName": {
              "type": "string",
              "defaultValue": "[format('gateway-{0}', uniqueString(resourceGroup().id))]"
            },
            "gatewayCertName": {
              "type": "string",
              "defaultValue": ""
            },
            "gatewayCertData": {
              "type": "string",
              "defaultValue": ""
            },
            "range": {
              "type": "string",
              "defaultValue": "10.0.0.0/16"
            },
            "clientRange": {
              "type": "string",
              "defaultValue": "10.0.2.0/24"
            },
            "gatewayRange": {
              "type": "string",
              "defaultValue": "10.0.100.0/24"
            },
            "gatewayClientRange": {
              "type": "string",
              "defaultValue": "10.10.10.0/24"
            },
            "dns": {
              "type": "array",
              "defaultValue": [
                "168.63.129.16"
              ]
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "gatewaySku": {
              "type": "string",
              "defaultValue": "VpnGw1"
            },
            "gatewayGeneration": {
              "type": "string",
              "defaultValue": "Generation1"
            },
            "vpnClientProtocol": {
              "type": "array",
              "defaultValue": [
                "SSTP"
              ]
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2024-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('range')]"
                  ]
                },
                "dhcpOptions": {
                  "dnsServers": "[parameters('dns')]"
                }
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks/subnets",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', parameters('name'), 'GatewaySubnet')]",
              "properties": {
                "addressPrefix": "[parameters('gatewayRange')]",
                "privateEndpointNetworkPolicies": "Enabled",
                "privateLinkServiceNetworkPolicies": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2024-05-01",
              "name": "nat-pub-ip",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAllocationMethod": "Static"
              }
            },
            {
              "type": "Microsoft.Network/natGateways",
              "apiVersion": "2024-05-01",
              "name": "client-subnet-gateway",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIpAddresses": [
                  {
                    "id": "[resourceId('Microsoft.Network/publicIPAddresses', 'nat-pub-ip')]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', 'nat-pub-ip')]"
              ]
            },
            {
              "type": "Microsoft.Network/virtualNetworks/subnets",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}/{1}', parameters('name'), 'client-subnet')]",
              "properties": {
                "addressPrefix": "[parameters('clientRange')]",
                "natGateway": {
                  "id": "[resourceId('Microsoft.Network/natGateways', 'client-subnet-gateway')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/natGateways', 'client-subnet-gateway')]",
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}-pub-ip', parameters('gatewayName'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAllocationMethod": "Static",
                "publicIPAddressVersion": "IPv4"
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworkGateways",
              "apiVersion": "2024-05-01",
              "name": "[parameters('gatewayName')]",
              "location": "[parameters('location')]",
              "properties": {
                "gatewayType": "Vpn",
                "ipConfigurations": [
                  {
                    "name": "default",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "subnet": {
                        "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('name'), 'GatewaySubnet')]"
                      },
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-pub-ip', parameters('gatewayName')))]"
                      }
                    }
                  }
                ],
                "vpnType": "RouteBased",
                "vpnGatewayGeneration": "[parameters('gatewayGeneration')]",
                "sku": {
                  "name": "[parameters('gatewaySku')]",
                  "tier": "[parameters('gatewaySku')]"
                },
                "vpnClientConfiguration": {
                  "vpnClientAddressPool": {
                    "addressPrefixes": [
                      "[parameters('gatewayClientRange')]"
                    ]
                  },
                  "vpnClientProtocols": "[parameters('vpnClientProtocol')]",
                  "vpnAuthenticationTypes": [
                    "Certificate"
                  ],
                  "vpnClientRootCertificates": "[if(and(not(empty(parameters('gatewayCertName'))), not(empty(parameters('gatewayCertData')))), createArray(createObject('name', parameters('gatewayCertName'), 'properties', createObject('publicCertData', parameters('gatewayCertData')))), createArray())]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('name'), 'GatewaySubnet')]",
                "[resourceId('Microsoft.Network/publicIPAddresses', format('{0}-pub-ip', parameters('gatewayName')))]"
              ]
            }
          ],
          "outputs": {
            "gatewaySubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('name'), 'GatewaySubnet')]"
            },
            "clientSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('name'), 'client-subnet')]"
            }
          }
        }
      }
    },
    "servers": {
      "copy": {
        "name": "servers",
        "count": "[length(variables('labServers'))]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('servers-{0}-{1}', copyIndex(), uniqueString('servers', deployment().name))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('labServers')[copyIndex()].name]"
          },
          "osType": {
            "value": "[variables('labServers')[copyIndex()].osType]"
          },
          "publisher": {
            "value": "[variables('labServers')[copyIndex()].publisher]"
          },
          "offer": {
            "value": "[variables('labServers')[copyIndex()].offer]"
          },
          "sku": {
            "value": "[variables('labServers')[copyIndex()].sku]"
          },
          "size": {
            "value": "[parameters('size')]"
          },
          "password": {
            "value": "[parameters('password')]"
          },
          "username": {
            "value": "[parameters('username')]"
          },
          "subnetId": {
            "value": "[reference('network').outputs.clientSubnetId.value]"
          },
          "privateIp": "[if(not(empty(variables('labServers')[copyIndex()].ip)), createObject('value', variables('labServers')[copyIndex()].ip), createObject('value', format('10.50.30.{0}', add(copyIndex(), 50))))]",
          "storageType": {
            "value": "Standard_LRS"
          },
          "requirePlan": {
            "value": "[variables('labServers')[copyIndex()].requirePlan]"
          },
          "tags": {
            "value": "[variables('labServers')[copyIndex()].tags]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "8269912040122797847"
            }
          },
          "parameters": {
            "subnetId": {
              "type": "string"
            },
            "privateIp": {
              "type": "string"
            },
            "storageType": {
              "type": "string"
            },
            "username": {
              "type": "string"
            },
            "password": {
              "type": "securestring"
            },
            "requirePlan": {
              "type": "bool",
              "defaultValue": false
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "name": {
              "type": "string",
              "defaultValue": "Server2016"
            },
            "size": {
              "type": "string",
              "defaultValue": "Standard_B4ms"
            },
            "publisher": {
              "type": "string",
              "defaultValue": "MicrosoftWindowsServer"
            },
            "offer": {
              "type": "string",
              "defaultValue": "WindowsServer"
            },
            "sku": {
              "type": "string",
              "defaultValue": "2016-Datacenter"
            },
            "version": {
              "type": "string",
              "defaultValue": "latest"
            },
            "osType": {
              "type": "string",
              "defaultValue": "Windows",
              "allowedValues": [
                "Linux",
                "Windows"
              ]
            }
          },
          "resources": {
            "networkInterface": {
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2024-05-01",
              "name": "[format('{0}-nic', parameters('name'))]",
              "location": "[parameters('location')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig1",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('subnetId')]"
                      },
                      "privateIPAllocationMethod": "Static",
                      "privateIPAddress": "[parameters('privateIp')]"
                    }
                  }
                ]
              }
            },
            "serverVm": {
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2024-11-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('size')]"
                },
                "osProfile": "[if(equals(parameters('osType'), 'Linux'), createObject('adminPassword', parameters('password'), 'adminUsername', parameters('username'), 'computerName', parameters('name'), 'allowExtensionOperations', true(), 'linuxConfiguration', createObject('disablePasswordAuthentication', false(), 'provisionVMAgent', true(), 'patchSettings', createObject('patchMode', 'ImageDefault', 'assessmentMode', 'ImageDefault'))), createObject('adminPassword', parameters('password'), 'adminUsername', parameters('username'), 'computerName', parameters('name'), 'allowExtensionOperations', true()))]",
                "storageProfile": {
                  "imageReference": {
                    "publisher": "[parameters('publisher')]",
                    "offer": "[parameters('offer')]",
                    "sku": "[parameters('sku')]",
                    "version": "[parameters('version')]"
                  },
                  "osDisk": {
                    "name": "[format('{0}-osdisk', parameters('name'))]",
                    "createOption": "FromImage",
                    "managedDisk": {
                      "storageAccountType": "[parameters('storageType')]"
                    },
                    "osType": "[parameters('osType')]"
                  }
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}-nic', parameters('name')))]"
                    }
                  ]
                },
                "diagnosticsProfile": "[if(equals(parameters('osType'), 'Linux'), createObject('bootDiagnostics', createObject('enabled', true())), createObject())]"
              },
              "plan": "[if(parameters('requirePlan'), createObject('name', parameters('sku'), 'publisher', parameters('publisher'), 'product', parameters('offer')), null())]",
              "tags": "[parameters('tags')]",
              "dependsOn": [
                "networkInterface"
              ]
            },
            "schedule": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2025-04-01",
              "name": "[format('schedule-{0}', uniqueString('schedule', deployment().name))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[parameters('name')]"
                  },
                  "id": {
                    "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('name'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.39.26.7824",
                      "templateHash": "16303453078922318864"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string"
                    },
                    "id": {
                      "type": "string"
                    },
                    "time": {
                      "type": "string",
                      "defaultValue": "1900"
                    },
                    "timeZone": {
                      "type": "string",
                      "defaultValue": "Eastern Standard Time"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.DevTestLab/schedules",
                      "apiVersion": "2018-09-15",
                      "name": "[format('shutdown-computevm-{0}', toLower(parameters('name')))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "dailyRecurrence": {
                          "time": "[parameters('time')]"
                        },
                        "status": "Enabled",
                        "taskType": "ComputeVmShutdownTask",
                        "timeZoneId": "[parameters('timeZone')]",
                        "notificationSettings": {
                          "status": "Disabled"
                        },
                        "targetResourceId": "[parameters('id')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "serverVm"
              ]
            }
          }
        }
      },
      "dependsOn": [
        "network"
      ]
    }
  }
}