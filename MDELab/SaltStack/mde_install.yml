# This is a very basic way to deploy MDE using Salt Stack
# In order for this file to be used it should be renamed to .sls, but YML is used for dev tool formatting identification
#
install_packages_needed:
  pkg.installed:
    - pkgs:
      - unzip
      - libplist-utils
      - gpg
      - gnupg
      - apt-transport-https
  
add_ms_repo:
  cmd.run:
    - name: curl -o /etc/apt/sources.list.d/microsoft-prod.list https://packages.microsoft.com/config/ubuntu/18.04/prod.list

add_ms_keys:
  cmd.run:
    - name: curl -sSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/microsoft.gpg > /dev/null

update_repo:
  cmd.run:
    - name: apt update

install_mdatp:
  pkg.installed:
    - name: mdatp

# An example MDATP Managed JSON file can be found in the Ansible folder of this lab
copy_mde_configuration:
  file.managed:
    - name: /etc/opt/microsoft/mdatp/managed/mdatp_managed.json
    - source: salt://mde/mdatp_managed.json

# this assumes you have extracted the mdatp_onboard.json file to your salt shared file directory
copy_mde_onboarding_file:
  file.managed:
    - name: /etc/opt/microsoft/mdatp/mdatp_onboard.json
    - source: salt://mde/mdatp_onboard.json

